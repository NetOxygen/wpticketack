{"version":3,"sources":["app/Pass/BuyForm.js"],"names":["e","a","_typeof","Symbol","iterator","exports","define","amd","moment","this","obj","l","dependencies","BuyForm","$container","$pass","Object","prototype","toString","call","$selected_pass","attach","M","t","length","s","push","init","add_to_cart","$","userdata","h","_this","type","Y","serializeJSON","TKTApi","unusedTokens","unusedInput","overflow","pricing","charsLeftOver","nullInput","addPassToCart","invalidFormat","userInvalidated","_this2","iso","parsedDateParts","redirect","meridiem","url","_pf","topic","getCartViewUrl","isNaN","_d","getTime","empty","invalidMonth","invalidWeekday","weekdayMismatch","_strict","show_success","bigHour","isFrozen","_isValid","postal","f","c","n","some","$wrappers","alert","show_error","$field","sync_pass_form","detach","fields_to_show","o","_isAMomentObject","_i","_f","_l","_tzm","_isUTC","_offset","_locale","d","hide","each","p","k","required","NaN","isValid","Date","updateOffset","D","Math","ceil","floor"],"mappings":"CAAA,SAAAA,EAAAC,GAAAC,iBAAAC,SAAA,oBAAAA,OAAAC,OAAAC,QAAAJ,IAAA,mBAAAK,QAAAA,OAAAC,IAAAD,OAAA,SAAA,GAAAL,GAAAD,EAAAQ,OAAAP,IAAA,CAAAQ,KAAA,WAAA,aAAA,IAAAT,EAAAU,EAAA,SAAAC,qNAYO,SAASC,EAAAA,GAGZ,YAASC,IAAQC,EAAmB,SAE3BC,EAAAA,GAML,MAAA,iBAAsBf,GAAKe,oBAA3BC,OAAAC,UAAAC,SAAAC,KAAAnB,GARgC,SAFWoB,EAAAA,GAiB3CC,OAAAA,aAAQA,MAAAA,kBAAWP,OAfaG,UAAAC,SAAAC,KAAAnB,GAAA,SAFWsB,EAAAtB,EAAAC,GAqB1BY,IAAAI,EAAAA,EAAAA,GAAAI,IAAAA,EACT,EAAAE,EAAAvB,EAAAqB,SAAWG,EAAfC,EAAAC,KACIC,EADJ3B,EAAAuB,GAAeC,IAAAA,OADFC,EAMJG,SAAAA,EAAAA,EAAAA,GAAAA,OAFgDZ,OAJ5CD,UAAAS,eAI4CL,KAAAnB,EAAAC,GAEhD2B,SAImBC,EAAA7B,EAAAC,GAAA,IAAA,IACxB6B,KAAAA,EADwBC,EAAA9B,EAEF+B,KAAAJ,EAAAA,GAAAA,EAAAL,IAFE,OAJnBK,EAAAA,EAAAA,cAAAA,EAAAA,SAAAA,EAAAA,UAAAA,EAAAA,EAAAA,aAAAA,EAAAA,QAAAA,EAAAA,SAAAA,EANI,SAUeA,EAAAA,EAAAA,EAOxBK,EAAAA,GAAuBb,OAAAA,GAAAA,EAAAA,EAAAA,EAAAA,GAAAA,GAAAA,MAG3B,SAAAc,EAAAlC,GAAA,OACImC,MAAAA,EAAAA,MAJuBf,EAAAA,IAAAA,CAM3BgB,OAAAA,EACIC,aAAAjB,GADgEkB,YAAA,GAKhEC,UACIC,EAAAC,cAAA,EAAAC,WAEI,EACJN,aAAAO,KAAAC,eAAA,EAAAC,iBAGKC,EAHLC,KAGA,EAHAC,gBAMKC,GAALC,SACIC,KAAAA,SACAL,EADAK,iBADJ,IAAAnD,EAAAoD,IAIJD,SAAAA,EAAAA,GAJI,GAAA,MAQAE,EAAAA,SAAAA,CAAAA,IAAAA,EAvB4DF,EAAAA,GAAAf,EAAAA,EAAAA,KAAAkB,EAAAA,gBAuB5DD,SAAAA,GApCoB,OA4BpB,MAAArD,IA3CIyB,GAAA8B,MAAAvD,EAAAwD,GAAAC,YAAAxD,EAAAsC,SAAA,IAAAtC,EAAAyD,QAAAzD,EAAA0D,eAAA1D,EAAA2D,iBAAA3D,EAAA4D,kBAAA5D,EAAAyC,YAAAzC,EAAA2C,gBAAA3C,EAAA4C,mBAAA5C,EAAAiD,UAAAjD,EAAAiD,UAAA3B,GAAA,GAAAvB,EAAA8D,UAAA1B,EAAA2B,GAAAA,IAAAA,EAAA3B,eAAA,IAAAnC,EAAAoC,aAAAb,aAAA,IAAAvB,EAAA+D,SAAA,MAAAhD,OAAAiD,UAAAjD,OAAAiD,SAAAjE,GAAA,OAwDEyB,EAbNzB,EAAAkE,SANAzC,EAAA,OAAAzB,EArCImE,SAAA,SAAAC,EAAApE,GAAA,IAAAC,EAAAoE,EAAAF,KAqCJ,OAfmB/C,MAAAA,EAAAA,EAAAA,EAAAA,GAAAA,GAAAA,EAAAA,GAAAA,iBAAAA,EAAAA,EAjBdkD,EA2DeP,MAAAA,UA3DfQ,KAAAR,MAAAA,UAAAQ,KAoEDC,SAAAA,GAAAA,IAAkBC,IAAAA,EAAAA,OAAlBD,MAAAA,EAAAA,EAAAA,SAAAA,EAAAA,EAAAA,EAAAA,EAAAA,EAAAA,IApEC,GAAA/C,KAAAxB,GAAAD,EAAAmB,KAAAV,KAAAR,EAAAwB,GAAAA,EAAAxB,GAwEwByE,OAxExB,EAyELC,OAD6BF,GAxExB,IA2DeG,EAAAA,EAAAA,iBAhEhBA,GAAA,SAoFhBC,EAAAA,EAAQC,GApFQ,IAyFbjE,EAAAA,EAAAA,EAzGwC,GAAAkE,EAAA9E,EAHnDK,oBAAAA,EAAAA,iBAGmDL,EAAA+E,kBAAAD,EAAA9E,EAAAgF,MAAAjF,EAAAiF,GAAAhF,EAAAgF,IAAAF,EAAA9E,EAAAiF,MAAAlF,EAAAkF,GAAAjF,EAAAiF,IAAAH,EAAA9E,EAAAkF,MAAAnF,EAAAmF,GAAAlF,EAAAkF,IAAAJ,EAAA9E,EAAA6D,WAAA9D,EAAA8D,QAAA7D,EAAA6D,SAAAiB,EAAA9E,EAAAmF,QAAApF,EAAAoF,KAAAnF,EAAAmF,MAAAL,EAAA9E,EAAAoF,UAAArF,EAAAqF,OAAApF,EAAAoF,QAAAN,EAAA9E,EAAAqF,WAAAtF,EAAAsF,QAAArF,EAAAqF,SAAAP,EAAA9E,EAAAmD,OAAApD,EAAAoD,IAAAlB,EAAAjC,IAAA8E,EAAA9E,EAAAsF,WAAAvF,EAAAuF,QAAAtF,EAAAsF,SAAA,EAAAC,EAAAhE,OAAA,IAgB3BD,EAAA,EAAAA,EAAAiE,EAAAhE,OAAAD,IAuEZwD,EAAKP,EAAAA,EAAAA,EAAUiB,EAAAA,OAvEHzF,EAAAyB,GAAA6C,GAAA,OAyEVoB,EAA4B,IAAAzF,GAAA,EAAA,SAAA0F,EAAA3F,GAIO4F,EAAAnF,KAAAT,GAC7B2E,KAAAA,GAAOkB,IAAAA,KAAW,MADW7F,EAAAwD,GAAAxD,EAAAwD,GAAAC,UAAAqC,KAAArF,KAAAsF,YAAAtF,KAAA+C,GAAA,IAAAwC,KAAAF,OAAA,IAAA7F,IAAAA,GAAA,EAAAU,EAAAsF,aAAAxF,MAAAR,GAAA,GAAA,SAAAiG,EAAAlG,GAJP,OAzElBA,aAAA2F,GAAA,MAAA3F,GAAA,MAAAA,EAAAgF,iBAKC,SA+EjBH,EAAAA,GAAmB,OA/EF7E,EAAA,EAAAmG,KAAAC,KAAApG,IAAA,EAAAmG,KAAAE,MAAArG,GAoFrB,SAAOa,EAAAA,GA5GXP,IAAAA,GAAAA,EAAAA,EAAAA","file":"app.js","sourcesContent":["/**\n * Show a pass buy form\n *\n * Usage:\n *\n * <div\n *    <!-- Required -->\n *    data-component=\"Pass/BuyForm\"\n * >\n */\ndefine([\n        'config', 'postal', 'lodash', 'jquery', 'jqueryjson', 'api', 'i18n'\n    ], function dependencies(\n        config, postal, _, $, $json, TKTApi, i18n) {\n\n    function BuyForm($container, state) {\n        this.$container = $container;\n        this.$pass      = $('.pass', this.$container);\n\n        // Ensure $pass is always an array\n        if ('object' === typeof this.$pass)\n            this.$pass = [this.$pass];\n\n        this.$selected_pass = this.$pass[0];\n\n        this.$wrappers = $('.field-wrapper', this.$container);\n        this.$fields   = $('.field-wrapper .field', this.$container);\n    }\n\n    BuyForm.prototype = {\n        attach: function() {\n            this.init();\n        },\n\n        init: function() {\n            if (this.$pass.length == 1)\n                this.sync_pass_form(this.$pass[0].data('type'));\n\n            $('button[type=\"submit\"]', this.$container).click((e) => {\n                e.preventDefault();\n                this.add_to_cart($(e.target).data('redirect'));\n            });\n        },\n\n        add_to_cart: function(redirect) {\n            let userdata = $('.field:visible,.opaque_field', this.$container)\n                .filter(function(i) { return !!($(this).val()); })\n                .serializeJSON();\n            userdata.no_photo = true;\n\n            this.$selected_pass = $('.choose-pass:checked', this.$container).parents('.pass');\n            let type            = this.$selected_pass.data('type');\n\n            const pricing = $('.choose-pass:checked', this.$container).val();\n            if (!pricing)\n                return this.show_error(i18n.t('Veuillez choisir un tarif'));\n\n            TKTApi.addPassToCart(type, pricing, userdata, (err, status, rsp) => {\n                if (err)\n                    return this.show_error(i18n.t('Une erreur est survenue. Veuillez ré-essayer ultérieurement.'));\n\n                let url = null;\n                switch (redirect) {\n                    case 'none':\n                        this.show_success(i18n.t('Votre panier a été mis à jour'));\n                        break;\n                    case 'cart':\n                        url = config.get('cart_url');\n                        break;\n                    case 'tkt_cart':\n                        url = TKTApi.getCartViewUrl();\n                        break;\n                    case 'tkt_checkout':\n                        url = TKTApi.getCheckoutUrl();\n                        break;\n                }\n                url && (window.location.href = url);\n\n                postal.publish({\n                    channel: \"cart\",\n                    topic: \"reload\"\n                });\n            });\n        },\n\n        show_success(msg) {\n            alert(msg);\n        },\n\n        show_error(msg) {\n            alert(msg);\n        },\n\n        sync_pass_form: function (pass) {\n            let fields_to_show = $('#' + pass + '-fields').val().split(',');\n\n            // Set not required and hide all fields\n            $('.field', this.$container).each(function (i) {\n                $(this).required = false;\n            });\n            this.$wrappers.hide();\n\n            _.each(this.$wrappers, (w) => {\n                // Set required and show requested fields\n                let id     = $(w).attr('id').replace('field-wrapper-', '');\n                let $field = $('#' + id);\n                if (fields_to_show.includes(id)) {\n                    $field.required = true;\n                    $(w).fadeIn();\n                }\n            });\n        },\n\n        detach: function() {\n\n        }\n    };\n\n    return BuyForm;\n});\n"]}