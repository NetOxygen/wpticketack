{"version":3,"sources":["app/Pass/BuyForm.js"],"names":["_typeof","Symbol","iterator","obj","constructor","prototype","define","dependencies","config","postal","_","$","$json","TKTApi","i18n","EXIF","filetodataurl","BuyForm","$container","state","$pass","$selected_pass","$wrappers","$fields","attach","init","_this","length","sync_pass_form","data","submit","e","preventDefault","add_to_cart","redirect","_this2","userdata","filter","i","val","serializeJSON","no_photo","parents","type","pricing","indexOf","show_error","t","pass","split","addPassToCart","err","status","rsp","url","show_success","get","getCartViewUrl","getCheckoutUrl","window","location","href","publish","channel","topic","msg","html","show","fields_to_show","required_fields","requested_fields","map","field","endsWith","push","slice","each","attr","hide","w","id","replace","$field","$label","includes","fadeIn","removeClass","detach"],"mappings":"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","file":"app.js","sourcesContent":["/**\n * Show a pass buy form\n *\n * Usage:\n *\n * <div\n *    <!-- Required -->\n *    data-component=\"Pass/BuyForm\"\n * >\n */\ndefine([\n        'config', 'postal', 'lodash', 'jquery', 'jqueryjson', 'api', 'i18n', 'exif', 'filetodataurl'\n    ], function dependencies(\n        config, postal, _, $, $json, TKTApi, i18n, EXIF, filetodataurl) {\n\n    function BuyForm($container, state) {\n        this.$container = $container;\n        this.$pass      = $('.pass', this.$container);\n\n        // Ensure $pass is always an array\n        if ('object' === typeof this.$pass)\n            this.$pass = [this.$pass];\n\n        this.$selected_pass = this.$pass[0];\n\n        this.$wrappers = $('.field-wrapper', this.$container);\n        this.$fields   = $('.field-wrapper .field', this.$container);\n    }\n\n    BuyForm.prototype = {\n        attach: function() {\n            this.init();\n        },\n\n        init: function() {\n            if (this.$pass.length == 1)\n                this.sync_pass_form(this.$pass[0].data('type'));\n\n\n            $('form', this.$container).submit((e) => {\n                e.preventDefault();\n                this.add_to_cart($('button[type=\"submit\"]', this.$container).data('redirect'));\n                return false;\n            });\n        },\n\n        add_to_cart: function(redirect) {\n            let userdata = $('.field:visible,.opaque_field', this.$container)\n                .filter(function(i) { return !!($(this).val()); })\n                .serializeJSON();\n            userdata.no_photo = true;\n\n            this.$selected_pass = $('.choose-pass:checked', this.$container).parents('.pass');\n            let type            = this.$selected_pass.data('type');\n            let pricing         = $('.choose-pass:checked', this.$container).val();\n\n            if (!pricing) {\n                if ($('.choose-pass', this.$container).val().indexOf(':') === -1)\n                    return this.show_error(i18n.t('Veuillez choisir un tarif'));\n\n                const pass = $('.choose-pass', this.$container).val().split(':');\n                type    = pass[0];\n                pricing = pass[1];\n            }\n\n            TKTApi.addPassToCart(type, pricing, userdata, (err, status, rsp) => {\n                if (err)\n                    return this.show_error(i18n.t('Une erreur est survenue. Veuillez ré-essayer ultérieurement.'));\n\n                let url = null;\n                switch (redirect) {\n                    case 'none':\n                        this.show_success(i18n.t('Votre panier a été mis à jour'));\n                        break;\n                    case 'cart':\n                        url = config.get('cart_url');\n                        break;\n                    case 'tkt_cart':\n                        url = TKTApi.getCartViewUrl();\n                        break;\n                    case 'tkt_checkout':\n                        url = TKTApi.getCheckoutUrl();\n                        break;\n                }\n                url && (window.location.href = url);\n\n                postal.publish({\n                    channel: \"cart\",\n                    topic: \"reload\"\n                });\n            });\n        },\n\n        show_success(msg) {\n            $('.alert-success', this.$container).html(msg).show();\n        },\n\n        show_error(msg) {\n            $('.alert-danger', this.$container).html(msg).show();\n        },\n\n        sync_pass_form: function (pass) {\n            let fields_to_show   = $('#' + pass + '-fields').val().split(',');\n            let required_fields  = [];\n            let requested_fields = [];\n\n            fields_to_show.map(field => {\n                if (field.endsWith('?'))\n                    requested_fields.push(field.slice(0, -1));\n                else\n                    required_fields.push(field);\n            });\n\n            // Set not required and hide all fields\n            $('.field', this.$container).each(function (i) {\n                $(this).attr('required', false);\n            });\n            this.$wrappers.hide();\n\n            _.each(this.$wrappers, (w) => {\n                // Set required and show requested fields\n                let id     = $(w).attr('id').replace('field-wrapper-', '');\n                let $field = $('#' + id);\n                let $label = $('label[for='+id+']');\n                if (required_fields.includes(id)) {\n                    $field.attr('required', true);\n                    $(w).fadeIn();\n                } else if (requested_fields.includes(id)) {\n                    $label.removeClass('required');\n                    $(w).fadeIn();\n                }\n            });\n        },\n\n        detach: function() {\n\n        }\n    };\n\n    return BuyForm;\n});\n"]}