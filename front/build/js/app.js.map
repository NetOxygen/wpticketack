{"version":3,"sources":["app/Program/BookabilityState.js"],"names":["define","dependencies","$","_","async","TKTApi","MIN_SEATS_OCCUPATION","STATE_NOT_SOLD_HERE","STATE_NOT_BOOKABLE","STATE_ALMOST_NOT_BOOKABLE","STATE_BOOKABLE","BookabilityState","$container","state","addClass","prototype","attach","init","_this","items","ids","uniq","flatten","map","i","attr","split","chunks","chunk","tasks","done","getScreeningsInfo","err","status","rsp","each","s","_id","seats","sold_here","keys","pricings","length","eligible_types","parallel","results","max","available","occupation_percentage","removeClass","detach"],"mappings":"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","file":"app.js","sourcesContent":["/**\n * Handle program filters\n *\n * Usage:\n *\n * <[*]\n *    <!-- Required -->\n *    data-component=\"Program/BookabilityState\"\n * >\n *\n *   For each screening/event you want to check the bookability, add:\n *   <[*] data-bookability-ids=\"12345678-1234-1234-1234-123456789012,...\">\n *     <[*] class=\"show-while-loading\"></[*]>\n *     <[*] class=\"show-if-bookable\"></[*]>\n *     <[*] class=\"show-if-almost-not-bookable\"></[*]>\n *     <[*] class=\"show-if-not-bookable\"></[*]>\n *   </[*]>\n *\n * </[*]>\n */\ndefine(\n    ['jquery', 'lodash', 'async', 'api'],\n    function dependencies($, _, async, TKTApi) {\n\n    const MIN_SEATS_OCCUPATION = 90;\n\n    const STATE_NOT_SOLD_HERE       = 0;\n    const STATE_NOT_BOOKABLE        = 1;\n    const STATE_ALMOST_NOT_BOOKABLE = 2;\n    const STATE_BOOKABLE            = 3;\n\n    function BookabilityState($container, state) {\n        this.$container = $container;\n\n        this.$container\n            .addClass('tkt-bookability-state-wrapper')\n            .addClass('loading-bookability-state');\n    }\n\n    BookabilityState.prototype = {\n        attach: function() {\n            this.init();\n        },\n\n        init: function() {\n            const items = $('[data-bookability-ids]', this.$container);\n\n            if (!items)\n                return;\n\n            const ids = _.uniq(_.flatten(_.map(items, (i) => {\n                return $(i).attr('data-bookability-ids').split(',');\n            })));\n\n            let map = {};\n\n            const chunks = _.chunk(ids, 150);\n            const tasks  = _.map(chunks, (ids) => {\n                return (done) => {\n                    TKTApi.getScreeningsInfo(ids, (err, status, rsp) => {\n                        if (err)\n                            return done(err);\n\n                        _.each(rsp, (s) => {\n                            map[s._id] = {\n                                seats: s.seats,\n                                sold_here: _.keys(s.pricings).length > 0 || s.eligible_types.length > 0\n                            }\n                        });\n\n                        return done(/*err*/null);\n                    });\n                };\n            });\n\n            async.parallel(tasks, (err, results) => {\n                if (err)\n                    return err;\n\n                _.each(items, (i) => {\n                    let ids = $(i).attr('data-bookability-ids').split(',');\n                    let state = _.max(_.map(ids, (i) => {\n                        let seats     = map[i]['seats'];\n                        let sold_here = map[i]['sold_here'];\n                        if (!sold_here)\n                            return STATE_NOT_SOLD_HERE;\n                        if (seats.available == 0)\n                            return STATE_NOT_BOOKABLE;\n                        if (seats.occupation_percentage >= MIN_SEATS_OCCUPATION)\n                            return STATE_ALMOST_NOT_BOOKABLE;\n                        return STATE_BOOKABLE;\n                    }));\n\n                    switch (state) {\n                        case STATE_NOT_SOLD_HERE:\n                            return $(i).addClass('not-sold-here');\n                        case STATE_NOT_BOOKABLE:\n                            return $(i).addClass('not-bookable');\n                        case STATE_ALMOST_NOT_BOOKABLE:\n                            return $(i).addClass('almost-not-bookable');\n                        case STATE_BOOKABLE:\n                            return $(i).addClass('bookable');\n                    }\n                });\n\n                this.$container\n                    .removeClass('loading-bookability-state')\n                    .addClass('loaded-bookability-state');\n\n                $('.show-if-bookable,.show-if-almost-not-bookable,.show-if-not-bookable', this.$container).removeClass('d-none');\n            });\n        },\n\n        detach: function() {\n\n        }\n    };\n \n    return BookabilityState;\n});\n"]}