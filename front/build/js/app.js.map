{"version":3,"sources":["app/Pass/BuyForm.js"],"names":["e","a","_typeof","Symbol","iterator","exports","define","amd","moment","this","obj","l","dependencies","BuyForm","$container","$pass","Object","prototype","toString","call","$selected_pass","attach","M","t","length","s","push","init","add_to_cart","$","userdata","h","_this","type","Y","serializeJSON","TKTApi","unusedTokens","unusedInput","config","overflow","pricing","charsLeftOver","nullInput","_this2","addPassToCart","invalidFormat","userInvalidated","iso","parsedDateParts","show_success","msg","_pf","y","_isValid","isNaN","$wrappers","alert","show_error","$field","detach","n","Array","some","_","each","id","attr","replace","d","momentProperties","k","o","_isAMomentObject","_i","_f","_l","_strict","_tzm","_isUTC","_offset","_locale"],"mappings":"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","file":"app.js","sourcesContent":["/**\n * Show a pass buy form\n *\n * Usage:\n *\n * <div\n *    <!-- Required -->\n *    data-component=\"Pass/BuyForm\"\n * >\n */\ndefine([\n        'config', 'postal', 'lodash', 'jquery', 'jqueryjson', 'api', 'i18n'\n    ], function dependencies(\n        config, postal, _, $, $json, TKTApi, i18n) {\n\n    function BuyForm($container, state) {\n        this.$container = $container;\n        this.$pass      = $('.pass', this.$container);\n\n        // Ensure $pass is always an array\n        if ('object' === typeof this.$pass)\n            this.$pass = [this.$pass];\n\n        this.$selected_pass = this.$pass[0];\n\n        this.$wrappers = $('.field-wrapper', this.$container);\n        this.$fields   = $('.field-wrapper .field', this.$container);\n    }\n\n    BuyForm.prototype = {\n        attach: function() {\n            this.init();\n        },\n\n        init: function() {\n            if (this.$pass.length == 1)\n                this.sync_pass_form(this.$pass[0].data('type'));\n\n            $('button[type=\"submit\"]', this.$container).click((e) => {\n                e.preventDefault();\n                this.add_to_cart();\n            });\n        },\n\n        add_to_cart: function() {\n            let userdata = $('.field:visible,.opaque_field', this.$container)\n                .filter(function(i) { return !!($(this).val()); })\n                .serializeJSON();\n            userdata.no_photo = true;\n\n            this.$selected_pass = $('.choose-pass:checked', this.$container).parents('.pass');\n            let type            = this.$selected_pass.data('type');\n\n            const pricing = $('.choose-pass:checked', this.$container).val();\n            if (!pricing)\n                return this.show_error(i18n.t('Veuillez choisir un tarif'));\n\n            TKTApi.addPassToCart(type, pricing, userdata, (err, status, rsp) => {\n                if (err)\n                    return this.show_error(i18n.t('Une erreur est survenue. Veuillez ré-essayer ultérieurement.'));\n\n                const cart_url = config.get('cart_url');\n                if (cart_url)\n                    window.location.href = cart_url;\n                else\n                    this.show_success(i18n.t('Votre panier a été mis à jour'));\n\n                postal.publish({\n                    channel: \"cart\",\n                    topic: \"reload\"\n                });\n            });\n        },\n\n        show_success(msg) {\n            alert(msg);\n        },\n\n        show_error(msg) {\n            alert(msg);\n        },\n\n        sync_pass_form: function (pass) {\n            let fields_to_show = $('#' + pass + '-fields').val().split(',');\n\n            // Set not required and hide all fields\n            $('.field', this.$container).each(function (i) {\n                $(this).required = false;\n            });\n            this.$wrappers.hide();\n\n            _.each(this.$wrappers, (w) => {\n                // Set required and show requested fields\n                let id     = $(w).attr('id').replace('field-wrapper-', '');\n                let $field = $('#' + id);\n                if (fields_to_show.includes(id)) {\n                    $field.required = true;\n                    $(w).fadeIn();\n                }\n            });\n        },\n\n        detach: function() {\n\n        }\n    };\n\n    return BuyForm;\n});\n"]}