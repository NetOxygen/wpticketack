{"version":3,"sources":["app/BuyArticle/Form.js"],"names":["e","a","define","Form","prototype","init","$container","Object","toString","call","initialized","hasOwnProperty","variants","attach","init_store","getOwnPropertyNames","length","h","build_success_panel","build_variants_form","$input","val","d","$t","postal","s","channel","t","topic","push","data","build_form","$","$variants_form","$success_panel","appendTo","c","L","html","Template","unusedTokens","unusedInput","overflow","charsLeftOver","nullInput","chosen_articles","invalidEra","nb","invalidMonth","text","invalidFormat","userInvalidated","iso","parsedDateParts","era","meridiem","weekdayMismatch","target","_pf","Y","$qty","err","isNaN","_d","getTime","empty","invalidWeekday","_strict","bigHour","isFrozen","_isValid","_this2","detach","n","Array","shop_url","config","cart_url","get","process_add_to_cart","f","momentProperties","addClass","p","r","_isAMomentObject","_i","_f","_l","_tzm","_isUTC","_offset","_locale","k","this","Date","NaN","isValid","M","updateOffset","D","price","T","TKTApi","console","warn","l","deprecationHandler","errorMsg","removeClass","arguments","loadCart","status","slice","join","Error","stack","apply"],"mappings":"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","file":"app.js","sourcesContent":["/**\n * Show a booking form\n *\n * Usage:\n *\n * <div\n *    <!-- Required -->\n *    data-component=\"BuyArticle/Form\"\n *    data-article-id=\"12345678-1234-1234-1234-123456789012\"\n *    data-ids=\"12345678-1234-1234-1234-123456789012,...\"\n * >\n */\ndefine( [\n        'config', 'i18n', 'postal', 'lodash',\n        'template', 'jquery', 'api',\n        'moment', 'Cart'\n    ], function dependencies(\n        config, i18n, postal, _,\n        Template, $, TKTApi,\n        moment, CartModel) {\n\n    function Form($container, state) {\n        this.$container  = $container;\n        this.initialized = false;\n\n        //this.ids                = this.$container.data('ids').split(',');\n        //this.show_on_load       = parseInt(this.getUrlParam('book')) == 1;\n        //this.selected_screening = this.getUrlParam('s_id');\n    }\n\n    Form.prototype = {\n        attach: function() {\n            this.init_store();\n\n            // postal.subscribe({\n            //     channel: \"connection\",\n            //     topic: \"update\",\n            //     callback: (data, envelope) => {\n            //         //this.check_bookability();\n            //     }\n            // });\n\n            this.init();\n        },\n\n        init: function() {\n            this.data.article_id = this.$container.data('article-id');\n            this.data.variants   = this.$container.data('variants');\n\n            this.build_form();\n            this.initialized = true;\n        },\n\n        init_store: function() {\n            this.data = {\n                article_id: null, // selected article id\n                variants: [],     // current variants\n                articles: [],     // selected variants\n            };\n        },\n\n        emit_cart_update: function(cart) {\n            postal.publish({\n                channel: \"cart\",\n                topic: \"update\",\n                data: {\n                    cart: cart\n                }\n            });\n        },\n\n        build_form: function() {\n            this.$container.html(\"\");\n            this.$variants_form  = $('<div class=\"variants-form\"></div>').appendTo(this.$container);\n            this.$success_panel  = $('<div class=\"success-panel d-none\"></div>').appendTo(this.$container);\n\n            this.build_variants_form();\n            this.build_success_panel();\n        },\n\n        build_variants_form: function() {\n            // render template\n            this.$variants_form.html(Template.render('tkt-buy-article-form-pricings-tpl', {\n                variants: this.data.variants\n            }));\n\n            // bind pricings minus buttons if any\n            $('.tkt-minus-btn', this.$container).click((e) => {\n                const $t     = $(e.target);\n                const $input = $t.parent().next('.variant-input').eq(0);\n                const val    = parseInt($input.val());\n                if (val > 0) {\n                    $input.val(val - 1).trigger('change');\n                    const $qty = $t.parent().find('.variant-qty').eq(0);\n                    $qty.text(val - 1);\n                }\n                if (val > 1)\n                    $t.removeClass('tkt-grey-badge').addClass('tkt-dark-badge');\n                else\n                    $t.removeClass('tkt-dark-badge').addClass('tkt-grey-badge');\n            });\n\n            // bind pricings plus buttons if any\n            $('.tkt-plus-btn', this.$container).click((e) => {\n                const $t     = $(e.target);\n                const $input = $t.parent().next('.variant-input').eq(0);\n                const val    = parseInt($input.val());\n                $input.val(val + 1).trigger('change');\n                const $qty = $t.parent().find('.variant-qty').eq(0);\n                $qty.text(val + 1);\n                $('.tkt-minus-btn', $t.parent())\n                    .removeClass('tkt-grey-badge')\n                    .addClass('tkt-dark-badge');\n            });\n\n            // bind variant fields\n            $('.variant-input', this.$container).change((e) => {\n                const $input = $(e.target);\n                this.data.articles[$input.data('variant')] = parseInt($input.val());\n            });\n\n            // bind add-to-cart button\n            $('.add-to-cart-btn').click((e) => {\n              this.process_add_to_cart();\n            });\n        },\n\n        build_success_panel: function() {\n            // render template\n            this.$success_panel.html(Template.render('tkt-buy-article-form-success-tpl', {\n                shop_url: config.get('shop_url'),\n                cart_url: config.get('cart_url')\n            }));\n        },\n\n        process_add_to_cart: function() {\n            $('.variants-error').html(\"\").addClass('d-none');\n            $('.success-panel').addClass('d-none');\n\n\n            // Check chosen articles\n            const chosen_articles = _.find(this.data.articles, (nb) => nb > 0);\n            if (!chosen_articles) {\n                return $('.variants-error')\n                    .html(i18n.t('Veuillez choisir au moins un article'))\n                    .removeClass('d-none');\n            }\n\n            const variants = [];\n            this.data.articles.map((quantity, key) => {\n                variants.push({\n                    _id: this.data.variants[key]._id,\n                    quantity: quantity,\n                    price: this.data.variants[key].price['CHF']\n                });\n            })\n            // Add to cart\n            TKTApi.addArticlesToCart(\n                [{\n                    _id: this.data.article_id,\n                    variants: variants\n                }],\n                (err, status, rsp) => {\n                    if (err) {\n                        return $('.variants-error')\n                            .html((rsp || {}).errorMsg)\n                            .removeClass('d-none');\n                    }\n\n                // Hide forms and show success message\n                $('.variants-form').addClass('d-none');\n                $('.success-panel').removeClass('d-none');\n\n                // Reload and emit cart update\n                TKTApi.loadCart((err, status, rsp) => {\n                    if (err)\n                        return;\n\n                    this.emit_cart_update(new CartModel(rsp));\n                });\n            });\n        },\n\n        detach: function() {\n\n        }\n    };\n\n    return Form;\n});\n"]}