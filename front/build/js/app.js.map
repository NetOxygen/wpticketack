{"version":3,"sources":["app/Pass/BuyForm.js"],"names":["e","a","_typeof","Symbol","iterator","exports","define","amd","moment","this","obj","l","BuyForm","dependencies","config","Object","prototype","toString","call","u","Date","$wrappers","t","length","init","h","hasOwnProperty","L","_this","sync_pass_form","$","$container","preventDefault","s","va","utc","_pf","empty","add_to_cart","type","$selected_pass","overflow","pricing","charsLeftOver","nullInput","serializeJSON","userdata","no_photo","invalidFormat","userInvalidated","iso","parsedDateParts","meridiem","rfc2822","url","weekdayMismatch","TKTApi","addPassToCart","err","n","_d","getTime","invalidMonth","invalidWeekday","_strict","unusedTokens","bigHour","isFrozen","_isValid","_this2","postal","c","NaN","getCartViewUrl","Array","some","show_success","d","momentProperties","fields_to_show","k","o","msg","show_error","attr","isValid","updateOffset","D","required_fields","field","endsWith","Math","floor","g","r","_","w","suppressDeprecationWarnings","console","warn","fadeIn","deprecationHandler","arguments","detach","slice"],"mappings":"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","file":"app.js","sourcesContent":["/**\n * Show a pass buy form\n *\n * Usage:\n *\n * <div\n *    <!-- Required -->\n *    data-component=\"Pass/BuyForm\"\n * >\n */\ndefine([\n        'config', 'postal', 'lodash', 'jquery', 'jqueryjson', 'api', 'i18n', 'exif', 'filetodataurl'\n    ], function dependencies(\n        config, postal, _, $, $json, TKTApi, i18n, EXIF, filetodataurl) {\n\n    function BuyForm($container, state) {\n        this.$container = $container;\n        this.$pass      = $('.pass', this.$container);\n\n        // Ensure $pass is always an array\n        if ('object' === typeof this.$pass)\n            this.$pass = [this.$pass];\n\n        this.$selected_pass = this.$pass[0];\n\n        this.$wrappers = $('.field-wrapper', this.$container);\n        this.$fields   = $('.field-wrapper .field', this.$container);\n    }\n\n    BuyForm.prototype = {\n        attach: function() {\n            this.init();\n        },\n\n        init: function() {\n            if (this.$pass.length == 1)\n                this.sync_pass_form(this.$pass[0].data('type'));\n\n\n            $('form', this.$container).submit((e) => {\n                e.preventDefault();\n                this.add_to_cart($('button[type=\"submit\"]', this.$container).data('redirect'));\n                return false;\n            });\n\n            if ($('.popoverdata', this.$container).length) {\n                $('.popoverdata', this.$container).tooltip();\n            }\n        },\n\n        add_to_cart: function(redirect) {\n            let userdata = $('.field:visible,.opaque_field', this.$container)\n                .filter(function(i) { return !!($(this).val()); })\n                .serializeJSON();\n            userdata.no_photo = true;\n\n            this.$selected_pass = $('.choose-pass:checked', this.$container).parents('.pass');\n            let type            = this.$selected_pass.data('type');\n            let pricing         = $('.choose-pass:checked', this.$container).val();\n\n            if (!pricing) {\n                if ($('.choose-pass', this.$container).val().indexOf(':') === -1)\n                    return this.show_error(i18n.t('Veuillez choisir un tarif'));\n\n                const pass = $('.choose-pass', this.$container).val().split(':');\n                type    = pass[0];\n                pricing = pass[1];\n            }\n\n            TKTApi.addPassToCart(type, pricing, userdata, (err, status, rsp) => {\n                if (err)\n                    return this.show_error(i18n.t('Une erreur est survenue. Veuillez ré-essayer ultérieurement.'));\n\n                let url = null;\n                switch (redirect) {\n                    case 'none':\n                        this.show_success(i18n.t('Votre panier a été mis à jour'));\n                        break;\n                    case 'cart':\n                        url = config.get('cart_url');\n                        break;\n                    case 'tkt_cart':\n                        url = TKTApi.getCartViewUrl();\n                        break;\n                    case 'tkt_checkout':\n                        url = TKTApi.getCheckoutUrl();\n                        break;\n                }\n                url && (window.location.href = url);\n\n                postal.publish({\n                    channel: \"cart\",\n                    topic: \"reload\"\n                });\n            });\n        },\n\n        show_success(msg) {\n            $('.alert-success', this.$container).html(msg).show();\n        },\n\n        show_error(msg) {\n            $('.alert-danger', this.$container).html(msg).show();\n        },\n\n        sync_pass_form: function (pass) {\n            let fields_to_show   = $('#' + pass + '-fields').val().split(',');\n            let required_fields  = [];\n            let requested_fields = [];\n\n            fields_to_show.map(field => {\n                if (field.endsWith('?'))\n                    requested_fields.push(field.slice(0, -1));\n                else\n                    required_fields.push(field);\n            });\n\n            // Set not required and hide all fields\n            $('.field', this.$container).each(function (i) {\n                $(this).attr('required', false);\n            });\n            this.$wrappers.hide();\n\n            _.each(this.$wrappers, (w) => {\n                // Set required and show requested fields\n                let id     = $(w).attr('id').replace('field-wrapper-', '');\n                let $field = $('#' + id);\n                let $label = $('label[for='+id+']');\n                if (required_fields.includes(id)) {\n                    $field.attr('required', true);\n                    $(w).fadeIn();\n                } else if (requested_fields.includes(id)) {\n                    $label.removeClass('required');\n                    $(w).fadeIn();\n                }\n            });\n        },\n\n        detach: function() {\n\n        }\n    };\n\n    return BuyForm;\n});\n"]}