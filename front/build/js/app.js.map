{"version":3,"sources":["app/Articles/Article.js"],"names":["e","a","define","$variants","$go_to_cart","$container","state","Object","prototype","toString","call","$submit_error","init","$","_this","$triggers","attach","$total","map","t","length","push","s","h","hasOwnProperty","parseFloat","hide_messages","_","$quantity","parseInt","$sub","quantity","$submit","fadeOut","html","click","invalidMonth","invalidFormat","userInvalidated","fadeIn","iso","parsedDateParts","meridiem","rfc2822","show","weekdayMismatch","y","_isValid","Y","n","show_variants","_strict","charsLeftOver","unusedTokens","bigHour","isFrozen","hide_variants","show_error","f","show_submit_success","Array","some","show_submit_error","article","d","l","momentProperties","k","o","_isAMomentObject","_i","_f","_l","_tzm","_isUTC","_offset","_pf","_locale","build_articles_to_add","log","articles","this","addArticlesToCart","_d","getTime","NaN","isValid","Date","updateOffset","D","T","variants","Math","floor","g","isFinite","postal","publish","min","abs","r","add_to_cart","cart","_this2","w","suppressDeprecationWarnings","console","warn","TKTApi","L","deprecationHandler","rsp","flash","success","arguments","slice","err","join","Error","stack","apply","emit_cart_update","v","S","topic","data","H","detach","Article"],"mappings":"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","file":"app.js","sourcesContent":["/**\n * Handle Article buy\n *\n * Usage:\n *\n * <div\n *    <!-- Required -->\n *    data-component=\"Articles/Article\"\n *    data-id=\"12345678-1234-1234-1234-123456789012\"\n * >\n *   <[*] class=\"show-variants\"><[*]>\n * </div>\n */\ndefine(\n    ['postal', 'jquery', 'lodash', 'api', 'Cart', 'bootstrap'],\n    function dependencies(postal, $, _, TKTApi, CartModel) {\n\n        function Article($container, state) {\n            this.$container = $container;\n\n            this._id = this.$container.data('id');\n\n            this.$triggers       = $('.show-variants', this.$container);\n            this.$closers        = $('.close-variants', this.$container);\n            this.$modal          = $('.article-variants-form', this.$container);\n            this.$variants       = $('.variant-wrapper', this.$container);\n            this.$submit         = $('.variants-submit', this.$container);\n            this.$go_to_cart     = $('.go-to-cart', this.$container);\n            this.$error          = $('.variants-error', this.$container);\n            this.$submit_success = $('.variants-submit-success', this.$container);\n            this.$submit_error   = $('.variants-submit-error', this.$container);\n        }\n\n        Article.prototype = {\n            attach: function() {\n                this.init();\n            },\n\n            init: function() {\n                this.$triggers.click((e) => this.show_variants(e));\n                this.$closers.click((e) => this.hide_variants(e));\n\n                const $total = $('.variant-total', this.$container);\n\n                _.map(this.$variants, (v) => {\n                    const v_id = $(v).data('id');\n\n                    const $sub      = $('.variant-sub', $(v));\n                    const $add      = $('.variant-add', $(v));\n                    const $quantity = $('.variant-quantity', $(v));\n                    const price     = parseFloat($('.variant-price', $(v)).data('price'));\n\n                    $add.click((e) => {\n                        this.hide_messages();\n                        this.$submit.fadeIn();\n                        $quantity.html(parseInt($quantity.html()) + 1);\n                        $total.html((parseFloat($total.html()) + price).toFixed(2));\n                    });\n\n                    $sub.click((e) => {\n                        const quantity = parseInt($quantity.html());\n                        if (quantity <= 0)\n                            return;\n\n                        if (quantity == 1)\n                            this.$submit.fadeOut();\n\n                        $quantity.html(quantity - 1);\n                        $total.html(parseFloat(($total.html()) - price).toFixed(2));\n                    });\n                });\n\n                this.$submit.click((e) => {\n                    this.add_to_cart();\n                });\n            },\n\n            show_variants: function (e) {\n                this.$modal.fadeIn();\n            },\n\n            hide_variants: function (e) {\n                this.$modal.fadeOut();\n            },\n\n            show_error: function() {\n                this.$error.show();\n            },\n\n            show_submit_success: function(msg) {\n                this.hide_messages();\n                this.$submit_success.html(msg).show();\n            },\n\n            show_submit_error: function(err) {\n                this.$submit_error.html(err).show();\n            },\n\n            hide_messages: function() {\n                this.$go_to_cart.fadeOut();\n                this.$error.fadeOut();\n                this.$submit_success.fadeOut();\n                this.$submit_error.fadeOut();\n            },\n\n            build_articles_to_add: function() {\n                let article = {\n                    \"_id\": this._id,\n                    \"variants\": []\n                };\n                _.map(this.$variants, (v) => {\n                    const v_id = $(v).data('id');\n\n                    const $quantity = $('.variant-quantity', $(v));\n                    const quantity  = parseInt($quantity.html());\n                    if (quantity <= 0)\n                        return false;\n\n                    const price = parseFloat($('.variant-price', $(v)).data('price'));\n\n                    article.variants.push({\n                        \"_id\": v_id,\n                        \"quantity\": quantity,\n                        \"price\": price\n                    });\n                });\n\n                return [ article ];\n            },\n\n            add_to_cart: function() {\n                const articles = this.build_articles_to_add();\n                console.log(articles);\n\n                if (_.isEmpty(articles[0].variants)) {\n                    this.show_error();\n                    return false;\n                }\n\n                // Add to cart\n                TKTApi.addArticlesToCart(articles, (err, status, rsp) => {\n                    if (err)\n                        return this.show_submit_error(rsp.errorMsg);\n\n                    this.show_submit_success(rsp.flash.success);\n                    $('.variant-quantity').html(0);\n                    $('.variant-total').html('0.00');\n                    this.$go_to_cart.fadeIn();\n                    this.$submit.fadeOut();\n\n                    // Reload and emit cart update\n                    TKTApi.loadCart((err, status, rsp) => {\n                        if (err)\n                            return;\n\n                        this.emit_cart_update(new CartModel(rsp));\n                    });\n                });\n            },\n\n            emit_cart_update: function(cart) {\n                postal.publish({\n                    channel: \"cart\",\n                    topic: \"update\",\n                    data: {\n                        cart: cart\n                    }\n                });\n            },\n\n            detach: function() {\n\n            }\n        };\n\n        return Article;\n    });\n"]}