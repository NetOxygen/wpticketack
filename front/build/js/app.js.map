{"version":3,"sources":["app/Booking/Form.js"],"names":["e","a","define","initialized","config","Template","show_on_load","moment","selected_screening","attach","getUrlParam","Object","prototype","toString","call","Form","postal","subscribe","M","channel","$","s","t","preventDefault","push","_this","TKTApi","getScreeningsInfo","topic","callback","screening","check_bookability","c","va","_this2","init","_pf","init_store","unusedTokens","data","unusedInput","screenings","overflow","charsLeftOver","pass_infos","nullInput","invalidMonth","bookability","invalidFormat","userInvalidated","iso","parsedDateParts","meridiem","rfc2822","pricings","ticket","emit_cart_update","reset_store_on_screening_change","NaN","deinit","Array","this","length","chosen_pricings","cart","n","emit_connection_update","_isAMomentObject","o","_i","_f","_l","_strict","_tzm","_isUTC","_offset","Y","_locale","d","publish","p","book","Date","process_add_to_cart","getTime","isValid","_d","l","updateOffset","Math","floor","g","addToCart","err","isFinite","T","r","number","_this5","checkBookability","deprecationHandler","Error","arguments","_this6","ticket_logged_in","$container","slice","w","_this4","addClass","join","stack","apply","v","connect_pass","H","build_dates_form","_this7","$dates_form","to_select","i","L","select_screening","window","location","href","getTicketViewUrl","set","suppressDeprecationWarnings","keys","_this8","x","P","toLowerCase","O","click","h","E","F","build_tickets_form","pow","max","appendTo","name","html","render","R","$date","C","N","match","z","console","log","seats","available","replace","G","ticket_view_url","lastIndex","$input","target","U","V","K","B","q","Q","X","ee","ae","te","se","ne","de","re","_e","ie","ue","le","build_success_panel","program_url","cart_url","_w","he","Le","screening_id","fe","ke","pe","De","_","ge","I","regex","results","year","detach","key","val"],"mappings":"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","file":"app.js","sourcesContent":["/**\n * Show a booking form\n *\n * Usage:\n *\n * <div\n *    <!-- Required -->\n *    data-component=\"Booking/Form\"\n *    data-ids=\"12345678-1234-1234-1234-123456789012,...\"\n * >\n */\ndefine( [\n        'config', 'postal', 'lodash',\n        'template', 'jquery', 'api',\n        'moment', 'Cart', 'Screening', 'Ticket'\n    ], function dependencies(\n        config, postal, _,\n        Template, $, TKTApi,\n        moment, CartModel, Screening, Ticket) {\n\n    function Form($container, state) {\n        this.$container  = $container;\n        this.initialized = false;\n\n        this.ids                = this.$container.data('ids').split(',');\n        this.show_on_load       = parseInt(this.getUrlParam('book')) == 1;\n        this.selected_screening = this.getUrlParam('s_id');\n    }\n\n    Form.prototype = {\n        attach: function() {\n            this.init_store();\n\n            $('.show-booking-form').click((e) => {\n                e.preventDefault();\n\n                if (this.initialized)\n                    return this.deinit();\n\n                this.init();\n            });\n\n            postal.subscribe({\n                channel: \"connection\",\n                topic: \"update\",\n                callback: (data, envelope) => {\n                    this.check_bookability();\n                }\n            });\n\n            if (this.show_on_load)\n                this.init();\n        },\n\n        init: function() {\n            TKTApi.getScreeningsInfo(this.ids, (err, status, rsp) => {\n                this.data.screenings = rsp.map((s) => {\n                    let screening = new Screening(s);\n                    screening.eligible_types = s.eligible_types;\n\n                    return screening;\n                });\n                this.data.screenings = _.sortBy(this.data.screenings, (s) => s.start_at);\n                this.build_form();\n                this.initialized = true;\n            });\n        },\n\n        init_store: function() {\n            this.data = {\n                screenings: [], // current screenings\n                screening: {},  // selected screening\n                pricings: [],   // selected screening pricings\n                pass_infos: {}, // connection infos\n                ticket: {},     // active ticket\n                bookability: {} //selected screening bookability with  active ticket\n            };\n        },\n\n        reset_store_on_screening_change: function() {\n            this.data.screening   = {};\n            this.data.pricings    = {};\n            this.data.pass_infos  = {};\n            this.data.bookability = {};\n        },\n\n        deinit: function() {\n            this.$container.html(\"\");\n            this.initialized = false;\n        },\n\n        emit_cart_update: function(cart) {\n            postal.publish({\n                channel: \"cart\",\n                topic: \"update\",\n                data: {\n                    cart: cart\n                }\n            });\n        },\n\n        emit_connection_update: function(ticket) {\n            postal.publish({\n                channel: \"connection\",\n                topic: \"update\",\n                data: {\n                    ticket: ticket\n                }\n            });\n        },\n\n        process_add_to_cart: function() {\n            $('.pricings-error').html(\"\").addClass('d-none');\n\n            // Check chosen pricings\n            const chosen_pricings = _.find(this.data.pricings, (nb) => nb > 0);\n            if (!chosen_pricings) {\n                return $('.pricings-error')\n                    .html('Veuillez choisir au moins un billet')\n                    .removeClass('d-none');\n            }\n\n            // Add to cart\n            TKTApi.addToCart(\n                this.data.screening._id,\n                this.data.pricings,\n                (err, status, rsp) => {\n                    if (err) {\n                        return $('.pricings-error')\n                            .html(rsp.errorMsg)\n                            .removeClass('d-none');\n                    }\n\n                // Hide forms and show success message\n                $('.dates-form, .tickets-form').addClass('d-none');\n                $('.success-panel').removeClass('d-none');\n\n                // Reload and emit cart update\n                TKTApi.loadCart((err, status, rsp) => {\n                    if (err)\n                        return;\n\n                    this.emit_cart_update(new CartModel(rsp));\n                });\n            });\n        },\n\n        book: function() {\n            if (!this.data.screening._id)\n                return new Error(\"No screening\");\n\n            TKTApi.book(this.data.screening._id, (err, status, rsp) => {\n                if (err) {\n                    $('.book-form-success', this.$container).addClass('d-none');\n                    $('.book-form-error', this.$container)\n                        .html(\"Une erreur est survenue. Veuillez ré-essayer ultérieurement.\")\n                        .removeClass('d-none');\n                } else if (rsp.flash && rsp.flash.error) {\n                    $('.book-form-success', this.$container).addClass('d-none');\n                    $('.book-form-error', this.$container)\n                        .html(rsp.flash.error)\n                        .removeClass('d-none');\n                } else {\n                    $('.book-form-error', this.$container).addClass('d-none');\n                    $('.book-form-success', this.$container)\n                        .html(rsp.flash.success)\n                        .removeClass('d-none');\n                }\n\n                this.check_bookability();\n            });\n        },\n\n        connect_pass: function() {\n            $('.pass-error', this.$container).html(\"\").addClass('d-none');\n\n            if (!this.data.pass_infos.number || !this.data.pass_infos.key)\n                return $('.pass-error')\n                    .html('Veuillez remplir les deux champs')\n                    .removeClass('d-none');\n\n            TKTApi.loginTicket(\n                this.data.pass_infos.number,\n                this.data.pass_infos.key,\n                (err, status, rsp) => {\n                    if (err)\n                        return $('.pass-error')\n                            .html('Les informations que vous avez saisies sont invalides')\n                            .removeClass('d-none');\n\n                    this.data.ticket = new Ticket(rsp);\n                    this.emit_connection_update(this.data.ticket);\n\n                    // Redirect to ticket activation if needed\n                    if (this.data.ticket.status == \"new\")\n                        window.location.href =  TKTApi.getTicketViewUrl();\n                }\n            );\n        },\n\n        check_bookability: function(callback) {\n            if (!this.data.screening._id)\n                return new Error(\"No screening\");\n\n            TKTApi.checkBookability(this.data.screening._id, (err, status, rsp) => {\n                if (err)\n                    return false;\n\n                this.data.bookability = rsp;\n\n                if (this.data.bookability.ticket_logged_in) {\n                    $('.connect-panel', this.$container).addClass('d-none');\n                    $('.book-panel', this.$container).removeClass('d-none');\n                    $('.show-bookings-btn', this.$container).removeClass('d-none');\n\n                    if (this.data.bookability.ticket_can_book_screening) {\n                        $('.book-btn', this.$container).removeClass('d-none');\n                        $('.book-form-error', this.$container).addClass('d-none');\n                    } else {\n                        $('.book-btn', this.$container).addClass('d-none');\n                        const msg = this.data.bookability.screening_already_booked ?\n                            \"Vous ne pouvez pas réserver plus de place pour cette séance avec votre abonnement.\" :\n                            \"Vous ne pouvez pas réserver de place pour cette séance avec votre abonnement.\";\n                        $('.book-form-error', this.$container)\n                            .html(msg)\n                            .removeClass('d-none');\n                    }\n                } else {\n                    $('.connect-panel', this.$container).removeClass('d-none');\n                    $('.book-panel', this.$container).addClass('d-none');\n                }\n            });\n        },\n\n        build_form: function() {\n            this.$container.html(\"\");\n            this.$dates_form    = $('<div class=\"dates-form\"></div>').appendTo(this.$container);\n            this.$tickets_form  = $('<div class=\"tickets-form\"></div>').appendTo(this.$container);\n            this.$success_panel = $('<div class=\"success-panel d-none\"></div>').appendTo(this.$container);\n\n            this.build_dates_form();\n            this.build_success_panel();\n        },\n\n        build_dates_form: function() {\n            // render template\n            this.$dates_form.html(Template.render('tkt-booking-form-dates-tpl', {\n                screenings: this.data.screenings,\n            }));\n\n            // bind dates choices\n            $('.date-wrapper span.date').click((e) => {\n                const $date = $(e.target);\n                this.select_screening($date.data('screening_id'));\n            });\n\n            // Select first non full date\n            let to_select = this.selected_screening;\n            if (!to_select) {\n                let i = this.data.screenings.length - 1;\n                while (i >= 0) {\n                    console.log(this.data.screenings[i].seats.available);\n                    if (this.data.screenings[i].seats.available > 0)\n                        to_select = this.data.screenings[i]._id;\n                    i--;\n                }\n            }\n            this.select_screening(to_select);\n        },\n\n        build_tickets_form: function() {\n            // render template\n            const ticket_view_url = TKTApi.getTicketViewUrl();\n            this.$tickets_form.html(Template.render('tkt-booking-form-pricings-tpl', {\n                screening: this.data.screening,\n                ticket_view_url\n            }));\n\n            // bind pricing fields\n            $('.pricing-input', this.$container).change((e) => {\n              const $input = $(e.target);\n              this.data.pricings[$input.data('pricing')] = parseInt($input.val());\n            });\n\n            // bind pass panel toggler\n            $('a.show-connect-panel-form', this.$container).click((e) => {\n                e.preventDefault();\n                $('.connect-panel-form').removeClass('d-none');\n            });\n\n            // bind pass fields\n            $('.pass-number-input,.pass-key-input', this.$container).change((e) => {\n              this.data.pass_infos = {\n                number: $('.pass-number-input', this.$container).val(),\n                key: $('.pass-key-input', this.$container).val()\n              };\n            });\n\n            // bind pass connect button\n            $('.connect-btn', this.$container).click(this.connect_pass.bind(this));\n\n            // bind book button\n            $('.book-btn').click(this.book.bind(this));\n\n            // bind add-to-cart button\n            $('.add-to-cart-btn').click((e) => {\n              this.process_add_to_cart();\n            });\n        },\n\n        build_success_panel: function() {\n            // render template\n            this.$success_panel.html(Template.render('tkt-booking-form-success-tpl', {\n                program_url: config.get('program_url'),\n                cart_url: config.get('cart_url')\n            }));\n        },\n\n        select_screening: function (screening_id) {\n            $('.date-wrapper .date').removeClass('active');\n            $('.date-wrapper .date[data-screening_id=\"' + screening_id + '\"]').addClass('active');\n\n            // reset data\n            this.reset_store_on_screening_change();\n\n            this.data.screening = _.find(this.data.screenings, (s) => s._id === screening_id );\n            this.build_tickets_form();\n\n            this.check_bookability();\n        },\n\n        getUrlParam(name) {\n            const url = window.location.href;\n            name = name.replace(/[\\[\\]]/g, '\\\\$&');\n            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),\n                results = regex.exec(url);\n            if (!results) return null;\n            if (!results[2]) return '';\n            return decodeURIComponent(results[2].replace(/\\+/g, ' '));\n        },\n\n        detach: function() {\n\n        }\n    };\n\n    return Form;\n});\n"]}