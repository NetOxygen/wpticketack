{"version":3,"sources":["app/Booking/Form.js"],"names":["e","a","define","initialized","config","Template","show_on_load","moment","selected_screening","attach","getUrlParam","Object","prototype","toString","call","Form","postal","subscribe","M","channel","$","s","t","preventDefault","push","_this","TKTApi","getScreeningsInfo","topic","callback","screening","check_bookability","c","va","_this2","init","_pf","init_store","unusedTokens","data","unusedInput","screenings","overflow","charsLeftOver","pass_infos","nullInput","invalidMonth","bookability","invalidFormat","userInvalidated","iso","parsedDateParts","meridiem","rfc2822","pricings","ticket","emit_cart_update","reset_store_on_screening_change","NaN","deinit","Array","this","length","chosen_pricings","cart","n","emit_connection_update","_isAMomentObject","o","_i","_f","_l","_strict","_tzm","_isUTC","_offset","Y","_locale","d","publish","p","book","Date","process_add_to_cart","getTime","isValid","_d","l","updateOffset","Math","floor","g","addToCart","err","isFinite","T","r","number","_this5","L","_this4","_this6","deprecationHandler","$container","arguments","ticket_can_book_screening","slice","w","addClass","join","Error","stack","apply","v","connect_pass","build_success_panel","H","$dates_form","html","$date","target","build_tickets_form","_this8","$tickets_form","h","i","j","key","suppressDeprecationWarnings","keys","x","P","toLowerCase","O","screening_already_booked","W","name","E","build_form","detach","$success_panel","build_dates_form","pow","max","substr","z","J","N","R","_this7","select_screening","ordinal","C","$input","match","parseInt","val","replace","removeClass","localeData","invalidDate","G","longDateFormat","lastIndex","click","test","K","B","q","Q","X","ee","ae","te","se","ne","de","re","_e","ie","program_url","get","cart_url","me","ue","le","location","href","m","regex","RegExp","results","Me","_w","decodeURIComponent","he","Le","ce","Ye","ye","fe","ke","pe","De","ge"],"mappings":"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","file":"app.js","sourcesContent":["/**\n * Show a booking form\n *\n * Usage:\n *\n * <div\n *    <!-- Required -->\n *    data-component=\"Booking/Form\"\n *    data-ids=\"12345678-1234-1234-1234-123456789012,...\"\n * >\n */\ndefine( [\n        'config', 'postal', 'lodash',\n        'template', 'jquery', 'api',\n        'moment', 'Cart', 'Screening', 'Ticket'\n    ], function dependencies(\n        config, postal, _,\n        Template, $, TKTApi,\n        moment, CartModel, Screening, Ticket) {\n\n    function Form($container, state) {\n        this.$container  = $container;\n        this.initialized = false;\n\n        this.ids                = this.$container.data('ids').split(',');\n        this.show_on_load       = parseInt(this.getUrlParam('book')) == 1;\n        this.selected_screening = this.getUrlParam('s_id');\n    }\n\n    Form.prototype = {\n        attach: function() {\n            this.init_store();\n\n            $('.show-booking-form').click((e) => {\n                e.preventDefault();\n\n                if (this.initialized)\n                    return this.deinit();\n\n                this.init();\n            });\n\n            postal.subscribe({\n                channel: \"connection\",\n                topic: \"update\",\n                callback: (data, envelope) => {\n                    this.check_bookability();\n                }\n            });\n\n            if (this.show_on_load)\n                this.init();\n        },\n\n        init: function() {\n            TKTApi.getScreeningsInfo(this.ids, (err, status, rsp) => {\n                this.data.screenings = rsp.map((s) => {\n                    let screening = new Screening(s);\n                    screening.eligible_types = s.eligible_types;\n\n                    return screening;\n                });\n                this.data.screenings = _.sortBy(this.data.screenings, (s) => s.start_at);\n                this.build_form();\n                this.initialized = true;\n            });\n        },\n\n        init_store: function() {\n            this.data = {\n                screenings: [], // current screenings\n                screening: {},  // selected screening\n                pricings: [],   // selected screening pricings\n                pass_infos: {}, // connection infos\n                ticket: {},     // active ticket\n                bookability: {} //selected screening bookability with  active ticket\n            };\n        },\n\n        reset_store_on_screening_change: function() {\n            this.data.screening   = {};\n            this.data.pricings    = {};\n            this.data.pass_infos  = {};\n            this.data.bookability = {};\n        },\n\n        deinit: function() {\n            this.$container.html(\"\");\n            this.initialized = false;\n        },\n\n        emit_cart_update: function(cart) {\n            postal.publish({\n                channel: \"cart\",\n                topic: \"update\",\n                data: {\n                    cart: cart\n                }\n            });\n        },\n\n        emit_connection_update: function(ticket) {\n            postal.publish({\n                channel: \"connection\",\n                topic: \"update\",\n                data: {\n                    ticket: ticket\n                }\n            });\n        },\n\n        process_add_to_cart: function() {\n            $('.pricings-error').html(\"\").addClass('d-none');\n\n            // Check chosen pricings\n            const chosen_pricings = _.find(this.data.pricings, (nb) => nb > 0);\n            if (!chosen_pricings) {\n                return $('.pricings-error')\n                    .html('Veuillez choisir au moins un billet')\n                    .removeClass('d-none');\n            }\n\n            // Add to cart\n            TKTApi.addToCart(\n                this.data.screening._id,\n                this.data.pricings,\n                (err, status, rsp) => {\n                    if (err) {\n                        return $('.pricings-error')\n                            .html(rsp.errorMsg)\n                            .removeClass('d-none');\n                    }\n\n                // Hide forms and show success message\n                $('.dates-form, .tickets-form').addClass('d-none');\n                $('.success-panel').removeClass('d-none');\n\n                // Reload and emit cart update\n                TKTApi.loadCart((err, status, rsp) => {\n                    if (err)\n                        return;\n\n                    this.emit_cart_update(new CartModel(rsp));\n                });\n            });\n        },\n\n        book: function() {\n            if (!this.data.screening._id)\n                return new Error(\"No screening\");\n\n            TKTApi.book(this.data.screening._id, (err, status, rsp) => {\n                if (err) {\n                    $('.book-form-success', this.$container).addClass('d-none');\n                    $('.book-form-error', this.$container)\n                        .html(\"Une erreur est survenue. Veuillez ré-essayer ultérieurement.\")\n                        .removeClass('d-none');\n                } else if (rsp.flash && rsp.flash.error) {\n                    $('.book-form-success', this.$container).addClass('d-none');\n                    $('.book-form-error', this.$container)\n                        .html(rsp.flash.error)\n                        .removeClass('d-none');\n                } else {\n                    $('.book-form-error', this.$container).addClass('d-none');\n                    $('.book-form-success', this.$container)\n                        .html(rsp.flash.success)\n                        .removeClass('d-none');\n                }\n\n                this.check_bookability();\n            });\n        },\n\n        connect_pass: function() {\n            $('.pass-error', this.$container).html(\"\").addClass('d-none');\n\n            if (!this.data.pass_infos.number || !this.data.pass_infos.key)\n                return $('.pass-error')\n                    .html('Veuillez remplir les deux champs')\n                    .removeClass('d-none');\n\n            TKTApi.loginTicket(\n                this.data.pass_infos.number,\n                this.data.pass_infos.key,\n                (err, status, rsp) => {\n                    if (err)\n                        return $('.pass-error')\n                            .html('Les informations que vous avez saisies sont invalides')\n                            .removeClass('d-none');\n\n                    this.data.ticket = new Ticket(rsp);\n                    this.emit_connection_update(this.data.ticket);\n                }\n            );\n        },\n\n        check_bookability: function(callback) {\n            if (!this.data.screening._id)\n                return new Error(\"No screening\");\n\n            TKTApi.checkBookability(this.data.screening._id, (err, status, rsp) => {\n                if (err)\n                    return false;\n\n                this.data.bookability = rsp;\n\n                if (this.data.bookability.ticket_logged_in) {\n                    $('.connect-panel', this.$container).addClass('d-none');\n                    $('.book-panel', this.$container).removeClass('d-none');\n                    $('.show-bookings-btn', this.$container).removeClass('d-none');\n\n                    if (this.data.bookability.ticket_can_book_screening) {\n                        $('.book-btn', this.$container).removeClass('d-none');\n                        $('.book-form-error', this.$container).addClass('d-none');\n                    } else {\n                        $('.book-btn', this.$container).addClass('d-none');\n                        const msg = this.data.bookability.screening_already_booked ?\n                            \"Vous ne pouvez pas réserver plus de place pour cette séance avec votre abonnement.\" :\n                            \"Vous ne pouvez pas réserver de place pour cette séance avec votre abonnement.\";\n                        $('.book-form-error', this.$container)\n                            .html(msg)\n                            .removeClass('d-none');\n                    }\n                } else {\n                    $('.connect-panel', this.$container).removeClass('d-none');\n                    $('.book-panel', this.$container).addClass('d-none');\n                }\n            });\n        },\n\n        build_form: function() {\n            this.$container.html(\"\");\n            this.$dates_form    = $('<div class=\"dates-form\"></div>').appendTo(this.$container);\n            this.$tickets_form  = $('<div class=\"tickets-form\"></div>').appendTo(this.$container);\n            this.$success_panel = $('<div class=\"success-panel d-none\"></div>').appendTo(this.$container);\n\n            this.build_dates_form();\n            this.build_success_panel();\n        },\n\n        build_dates_form: function() {\n            // render template\n            this.$dates_form.html(Template.render('tkt-booking-form-dates-tpl', {\n                screenings: this.data.screenings,\n            }));\n\n            // bind dates choices\n            $('.date-wrapper span.date').click((e) => {\n                const $date = $(e.target);\n                this.select_screening($date.data('screening_id'));\n            });\n\n            // Select first date\n            this.select_screening(this.selected_screening ?\n                this.selected_screening :\n                this.data.screenings[0]._id\n            );\n        },\n\n        build_tickets_form: function() {\n            // render template\n            this.$tickets_form.html(Template.render('tkt-booking-form-pricings-tpl', {\n                screening: this.data.screening\n            }));\n\n            // bind pricing fields\n            $('.pricing-input', this.$container).change((e) => {\n              const $input = $(e.target);\n              this.data.pricings[$input.data('pricing')] = parseInt($input.val());\n            });\n\n            // bind pass panel toggler\n            $('a.show-connect-panel-form', this.$container).click((e) => {\n                e.preventDefault();\n                $('.connect-panel-form').removeClass('d-none');\n            });\n\n            // bind pass fields\n            $('.pass-number-input,.pass-key-input', this.$container).change((e) => {\n              this.data.pass_infos = {\n                number: $('.pass-number-input', this.$container).val(),\n                key: $('.pass-key-input', this.$container).val()\n              };\n            });\n\n            // bind pass connect button\n            $('.connect-btn', this.$container).click(this.connect_pass.bind(this));\n\n            // bind book button\n            $('.book-btn').click(this.book.bind(this));\n\n            // bind add-to-cart button\n            $('.add-to-cart-btn').click((e) => {\n              this.process_add_to_cart();\n            });\n        },\n\n        build_success_panel: function() {\n            // render template\n            this.$success_panel.html(Template.render('tkt-booking-form-success-tpl', {\n                program_url: config.get('program_url'),\n                cart_url: config.get('cart_url')\n            }));\n        },\n\n        select_screening: function (screening_id) {\n            $('.date-wrapper .date').removeClass('active');\n            $('.date-wrapper .date[data-screening_id=\"' + screening_id + '\"]').addClass('active');\n\n            // reset data\n            this.reset_store_on_screening_change();\n\n            this.data.screening = _.find(this.data.screenings, (s) => s._id === screening_id );\n            this.build_tickets_form();\n\n            this.check_bookability();\n        },\n\n        getUrlParam(name) {\n            const url = window.location.href;\n            name = name.replace(/[\\[\\]]/g, '\\\\$&');\n            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),\n                results = regex.exec(url);\n            if (!results) return null;\n            if (!results[2]) return '';\n            return decodeURIComponent(results[2].replace(/\\+/g, ' '));\n        },\n\n        detach: function() {\n\n        }\n    };\n\n    return Form;\n});\n"]}